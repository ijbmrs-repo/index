name: Generate Article from Issue

on:
  issues:
    types: [opened, reopened]

jobs:
  generate:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Generate article files and sitemap
        run: |
          python << 'EOF'
          import json, re
          from pathlib import Path
          from xml.etree.ElementTree import Element, SubElement, ElementTree

          BASE_URL = "https://index.ijbmrs.org"

          body = """${{ github.event.issue.body }}"""

          def get_section(title):
              pattern = rf"### {title}\n+(.+?)(?:\n### |\Z)"
              m = re.search(pattern, body, re.S)
              return m.group(1).strip() if m else ""

          title = get_section("Article Title")
          authors = [a.strip() for a in get_section("Authors").splitlines() if a.strip()]
          volume = get_section("Volume")
          issue_no = get_section("Issue")
          year = get_section("Publication Year")
          doi = get_section("DOI (Zenodo)")
          pdf = get_section("PDF URL")

          articles_file = Path("articles.json")

          if articles_file.exists():
              data = json.loads(articles_file.read_text())
          else:
              data = {
                  "journal": {
                      "name": "International Journal of Business and Management Research Studies"
                  },
                  "articles": []
              }

          slug_num = len(data["articles"]) + 1
          slug = f"article-{slug_num:02d}"

          article = {
              "slug": slug,
              "title": title,
              "authors": authors,
              "volume": volume,
              "issue": issue_no,
              "year": year,
              "doi": doi,
              "pdf": pdf
          }

          data["articles"].append(article)
          articles_file.write_text(json.dumps(data, indent=2))

          out_dir = Path(f"articles/volume-{volume}/issue-{issue_no}")
          out_dir.mkdir(parents=True, exist_ok=True)

          article_url = f"{BASE_URL}/articles/volume-{volume}/issue-{issue_no}/{slug}.html"

          html = f"""<!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>{title}</title>
            <meta name="citation_title" content="{title}">
            {''.join(f'<meta name="citation_author" content="{a}">' for a in authors)}
            <meta name="citation_journal_title" content="International Journal of Business and Management Research Studies">
            <meta name="citation_volume" content="{volume}">
            <meta name="citation_issue" content="{issue_no}">
            <meta name="citation_publication_date" content="{year}">
            <meta name="citation_doi" content="{doi}">
            <meta name="citation_pdf_url" content="{pdf}">
          </head>
          <body>
            <h1>{title}</h1>
            <p><strong>Authors:</strong> {', '.join(authors)}</p>
            <p><a href="{pdf}">Download PDF</a></p>
          </body>
          </html>"""

          (out_dir / f"{slug}.html").write_text(html)

          # ---- Generate sitemap.xml ----
          urlset = Element("urlset", xmlns="http://www.sitemaps.org/schemas/sitemap/0.9")

          def add_url(loc):
              url = SubElement(urlset, "url")
              SubElement(url, "loc").text = loc

          add_url(f"{BASE_URL}/")

          for a in data["articles"]:
              add_url(
                  f"{BASE_URL}/articles/volume-{a['volume']}/issue-{a['issue']}/{a['slug']}.html"
              )

          ElementTree(urlset).write("sitemap.xml", encoding="utf-8", xml_declaration=True)
          EOF

      - name: Commit changes
        run: |
          git config user.name "ijbmrs-bot"
          git config user.email "bot@ijbmrs.org"
          git add articles.json articles/ sitemap.xml
          git commit -m "Add article and update sitemap"
          git push
